<!-- Scripts -->
<script src="assets/js/scripts.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Set the current year in the footer
    document.getElementById("year").textContent = new Date().getFullYear();

    // Handle Cookie Banner
    if (!localStorage.getItem('cookiesAccepted')) {
      document.getElementById('cookie-banner').style.display = 'block';
    }
    document.getElementById('accept-cookies').addEventListener('click', () => {
      localStorage.setItem('cookiesAccepted', 'true');
      document.getElementById('cookie-banner').style.display = 'none';
    });

    // API Gateway Preorder Submission
    const form = document.getElementById("preorder-form");
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      // Retrieve and process input values
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const quantityValue = document.getElementById("quantity").value;
      const quantity = Number(quantityValue); // Convert to a number
      const comments = document.getElementById("comments").value.trim();

      // Basic validation
      if (!email || !quantityValue) {
        console.error("Email and Quantity are required.");
        return;
      }

      // Build payload. (Extra fields won't hurt if your Lambda ignores them.)
      const payload = { name, email, quantity, comments };
      console.log("Payload to be sent:", payload);

      const loadingMessage = document.getElementById("loading-message");
      const successMessage = document.getElementById("success-message");
      const errorMessage = document.getElementById("error-message");

      // Show loading message
      loadingMessage.classList.remove("hidden-message");
      successMessage.classList.add("hidden-message");
      errorMessage.classList.add("hidden-message");

      try {
        const response = await fetch("https://wwrg1xdnr2.execute-api.us-west-1.amazonaws.com/live/create-checkout-session", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload),
        });

        // Check for HTTP errors
        if (!response.ok) {
          console.error("HTTP error:", response.status);
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Response data:", data);
        loadingMessage.classList.add("hidden-message"); // Hide loading

        if (data.url) {
          successMessage.classList.remove("hidden-message");
          form.reset(); // Reset the form on successful submission
          window.location.href = data.url; // Redirect to Stripe Checkout
        } else {
          console.error("Unexpected response structure:", data);
          errorMessage.classList.remove("hidden-message");
        }
      } catch (error) {
        console.error("Fetch error:", error);
        errorMessage.classList.remove("hidden-message");
        loadingMessage.classList.add("hidden-message"); // Hide loading on error
      }
    });
  });
</script>

<style>
  .hidden-message {
    display: none;
    font-size: 14px;
    text-align: center;
    margin-top: 10px;
  }
  #loading-message { color: blue; }
  #success-message { color: green; }
  #error-message { color: red; }
</style>
